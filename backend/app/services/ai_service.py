from typing import List, Dict, Optional
from openai import OpenAI
from app.core.config import settings
import json
import requests
import re


class AIService:
    def __init__(self):
        self.api_key = settings.OPENAI_API_KEY
        if self.api_key:
            self.client = OpenAI(api_key=self.api_key)
        else:
            self.client = None
    
    def search_book_info(self, title: str) -> Optional[str]:
        """Поиск информации о произведении в интернете"""
        try:
            # Извлекаем название произведения и автора
            # Убираем "Аудиокнига", "Читает" и т.д.
            clean_title = re.sub(r'аудиокнига|читает.*|\.', '', title, flags=re.IGNORECASE)
            clean_title = clean_title.strip()
            
            # Поиск через Wikipedia API
            search_query = f"{clean_title} краткое содержание сюжет"
            wikipedia_url = "https://ru.wikipedia.org/w/api.php"
            
            params = {
                "action": "opensearch",
                "search": clean_title,
                "limit": 1,
                "namespace": 0,
                "format": "json"
            }
            
            response = requests.get(wikipedia_url, params=params, timeout=5)
            if response.status_code == 200:
                data = response.json()
                if len(data) > 3 and len(data[3]) > 0:
                    # Получаем краткую информацию
                    page_title = data[1][0] if len(data[1]) > 0 else None
                    description = data[2][0] if len(data[2]) > 0 else None
                    
                    if description:
                        return f"Информация из Wikipedia: {description}"
            
            return None
        except Exception as e:
            print(f"Error searching book info: {e}")
            return None

    def generate_book_summary(self, title: str, description: str = "") -> Optional[str]:
        """Генерация краткого описания книги на основе названия и описания"""
        if not self.api_key:
            return None
        
        # Заготовленные описания для известных произведений
        known_summaries = {
            # Чехов - юмористические рассказы
            "лошадиная фамилия": "У генерала страшно разболелся зуб, и все вспомнили про чудо-знахаря, который лечит по телеграфу! Только вот беда - никто не может вспомнить его фамилию. Точно помнят, что она связана с лошадью... Овсов? Кобылин? Жеребцов? Как же, черт возьми, вспомнить эту проклятую фамилию?",
            
            "смерть чиновника": "Мелкий чиновник случайно чихает в театре - прямо на затылок важного генерала! Что теперь делать? Извиниться? Но сколько раз? И что, если извинений окажется мало? Одна глупая оплошность превращается в настоящий кошмар...",
            
            "толстый и тонкий": "Два школьных друга неожиданно встречаются на вокзале после многих лет разлуки. Один превратился в важного чиновника, другой так и остался бедным. Сначала радость встречи, объятия, воспоминания... Но что происходит, когда один узнает высокий чин другого? Неужели старая дружба не выдержит испытания чинопочитанием?",
            
            "хирургия": "В земской больнице дьячок с зубной болью приходит к фельдшеру. Вот только фельдшер - не совсем хирург... Что может пойти не так при простом удалении зуба? Готовьтесь к уморительной сцене «хирургической» операции по-русски!",
            
            "хамелеон": "Полицейский надзиратель разбирает дело: собака укусила человека. Вроде бы всё просто - наказать хозяина собаки. Но чья это собака? Может, генеральская? А может, и нет... Как быстро меняется мнение надзирателя в зависимости от того, чья это собака!",
            
            "унтер пришибеев": "Отставной унтер-офицер Пришибеев следит за порядком в деревне. Очень следит. Никому нельзя собираться, говорить, даже стоять! Но кто дал ему такое право? И чем закончится его самоуправство?",
            
            "дама с собачкой": "Курортный роман на ялтинской набережной. Оба женаты, оба несвободны, и оба понимают, что это лишь мимолетное увлечение... Или нет? Что происходит, когда случайная встреча превращается в настоящее чувство? Можно ли начать жизнь заново?",
            
            "душечка": "Женщина, которая живет чужими мнениями и чувствами. Она отражает своих мужей, как зеркало. Но что остается, когда зеркало пустое? История о поиске себя через других.",
            
            "ионыч": "Молодой врач приезжает в провинциальный городок полный сил и надежд. Проходят годы... Что остается от юношеских порывов? Как человек превращается в «Ионыча»? Горькая история о том, как засасывает обывательское болото.",
            
            "палата номер 6": "Врач психиатрической больницы ведет философские беседы с пациентом из палаты №6. Кто из них на самом деле безумец? Где граница между нормой и сумасшествием? И что, если однажды врач окажется по другую сторону решетки?",
            
            "дуэль": "Офицер живет с чужой женой на кавказском курорте, погрязнув в безделье. Его вызывают на дуэль. Трус и циник вдруг оказывается перед лицом смерти. Изменится ли человек, когда жизнь висит на волоске?",
            
            "крыжовник": "Чиновник всю жизнь мечтает о собственной усадьбе с кустами крыжовника. Он копит, экономит, женится на богатой... Наконец мечта сбывается. Но стоило ли оно того? История о том, как мечта может оказаться пустой.",
            
            # Чехов - общие темы
            "из воспоминаний идеалиста": "Воспоминания человека, который когда-то горел высокими идеалами. Что случилось с юношескими мечтами спустя годы? Как меняется человек, когда романтизм сталкивается с суровой действительностью? Честная исповедь о крушении иллюзий и взрослении души.",
            
            "жизнь прекрасна": "Простые житейские сцены, где трагическое и комическое идут рука об руку. Насколько жизнь действительно прекрасна, когда смотришь на нее через призму повседневных абсурдных ситуаций? Тонкая ирония и глубокое понимание человеческой натуры.",
            
            # Стефан Цвейг
            "страх": "Тайная связь замужней женщины грозит обернуться катастрофой. Некто знает её секрет и требует денег. Страх сжимает сердце всё сильнее... Кто этот шантажист? И как далеко готова зайти женщина, чтобы сохранить свою тайну?",
            
            "амок": "Корабельный врач рассказывает страшную историю. В тропической глуши к нему приходит женщина с отчаянной просьбой. Он отказывает. И тогда начинается амок - слепая разрушительная страсть, которая не остановится ни перед чем... Даже перед смертью.",
            
            "письмо незнакомки": "Писатель получает письмо от незнакомки в день своего рождения. Она пишет, что всю жизнь любила его... Но он даже не помнит её! Кто эта женщина? И почему её любовь осталась в тени, невидимой и безответной?",
        }
        
        # Проверяем, есть ли заготовленное описание
        title_lower = title.lower()
        for key, summary in known_summaries.items():
            if key in title_lower:
                return summary
        
        # Пытаемся найти информацию в интернете
        web_info = self.search_book_info(title)
        
        # Формируем промпт с учетом найденной информации
        if web_info:
            prompt = f"""Ты создаешь интригующие описания литературных произведений.

Название: {title}
Найденная информация: {web_info}

ЗАДАЧА:
Создай интригующее описание сюжета (2-4 предложения) на основе найденной информации.

ТРЕБОВАНИЯ:
- Опиши конкретный СЮЖЕТ произведения
- НЕ упоминай автора, актера, слово "аудиокнига"
- Используй стиль киноанонсов с вопросами для интриги
- Заинтересуй слушателя, но не раскрывай концовку

ПРИМЕРЫ стиля:
"У генерала страшно разболелся зуб... Как же вспомнить эту проклятую фамилию?"
"Мелкий чиновник чихает на генерала! Что делать? Сколько раз извиняться?"

Создай описание."""
        else:
            # Без интернет-информации
            prompt = f"""Ты знаток классической литературы. Опиши произведение интригующе.

Название: {title}

ТРЕБОВАНИЯ:
- 2-3 предложения
- НЕ упоминай автора, актера, слово "аудиокнига"
- Если знаешь сюжет - опиши его с интригой
- Если не знаешь - опиши общую атмосферу и темы
- Используй стиль киноанонсов

Создай описание."""

        try:
            # Используем requests напрямую для совместимости с проектными ключами
            headers = {
                "Content-Type": "application/json",
                "Authorization": f"Bearer {self.api_key}"
            }
            
            data = {
                "model": "gpt-3.5-turbo",
                "messages": [
                    {"role": "system", "content": "Ты креативный литературный критик, который пишет захватывающие описания книг в стиле киноанонсов. Создавай интригу и желание прочитать/послушать произведение."},
                    {"role": "user", "content": prompt}
                ],
                "max_tokens": 400,
                "temperature": 0.8
            }
            
            response = requests.post(
                "https://api.openai.com/v1/chat/completions",
                headers=headers,
                json=data,
                timeout=30
            )
            
            if response.status_code == 200:
                result = response.json()
                return result['choices'][0]['message']['content'].strip()
            else:
                print(f"Error generating summary: {response.status_code} - {response.text}")
                return None
                
        except Exception as e:
            print(f"Error generating summary: {e}")
            return None

    def discuss_quote(self, quote: str, context: str = "", history: Optional[List[Dict]] = None) -> Optional[str]:
        """Обсуждение цитаты с AI"""
        if not self.api_key or not self.client:
            return None
        
        # Формируем промпт
        prompt = ""
        if not history:
            prompt = f"""Помоги мне разобраться с этой цитатой из аудиокниги:

"{quote}"

{f'Контекст: {context}' if context else ''}

Что автор хотел сказать? Какой в этом смысл?"""
        else:
            prompt = context  # Если есть история, контекст это новый вопрос пользователя

        # Проверяем, что промпт не пустой
        if not prompt or not prompt.strip():
            print("Error: Empty prompt generated for discussion")
            return None

        # Формируем сообщения
        messages = [
            {
                "role": "system",
                "content": "Ты литературный аналитик, который помогает глубже понять смысл текстов. Отвечай развернуто, но не слишком академично. Помогай людям размышлять над прочитанным."
            }
        ]
        
        # Добавляем историю разговора если есть
        if history:
            messages.extend(history)
            
        messages.append({"role": "user", "content": prompt})
        
        try:
            response = self.client.chat.completions.create(
                model="gpt-3.5-turbo",  # Используем стандартную модель
                messages=messages,
                max_tokens=500,
                temperature=0.8,
            )
            
            return response.choices[0].message.content.strip()
        except Exception as e:
            print(f"Error discussing quote: {e}")
            return None

    def extract_author_from_title(self, title: str) -> Optional[str]:
        """Извлечение имени автора из названия плейлиста или видео"""
        if not self.client:
            # Простая эвристика без AI
            common_authors = ['Чехов', 'Толстой', 'Достоевский', 'Набоков', 'Пушкин', 'Гоголь', 'Тургенев']
            for author in common_authors:
                if author.lower() in title.lower():
                    return author
            return None
        
        prompt = f"""Извлеки имя автора из следующего названия плейлиста или видео с аудиокнигой:

"{title}"

Верни только имя автора (фамилию), без лишнего текста. Если автора определить невозможно, верни "Unknown"."""

        try:
            response = self.client.chat.completions.create(
                model="gpt-3.5-turbo",  # Используем стандартную модель
                messages=[
                    {"role": "system", "content": "Ты помощник для извлечения информации. Отвечай максимально кратко."},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=50,
                temperature=0.3,
            )
            
            author = response.choices[0].message.content.strip()
            return author if author != "Unknown" else None
        except Exception as e:
            print(f"Error extracting author: {e}")
            return None


# Singleton instance
ai_service = AIService()

