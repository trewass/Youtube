from typing import List, Dict, Optional
from openai import OpenAI
from app.core.config import settings
import json
import requests
import re
import random


class AIService:
    def __init__(self):
        self.api_key = settings.OPENAI_API_KEY
        if self.api_key:
            self.client = OpenAI(api_key=self.api_key)
        else:
            self.client = None
    
    def search_book_info(self, title: str) -> Optional[str]:
        """Поиск информации о произведении в интернете"""
        try:
            # Извлекаем название произведения и автора
            # Убираем "Аудиокнига", "Читает" и т.д.
            clean_title = re.sub(r'аудиокнига|читает.*|\.', '', title, flags=re.IGNORECASE)
            clean_title = clean_title.strip()
            
            # Поиск через Wikipedia API
            search_query = f"{clean_title} краткое содержание сюжет"
            wikipedia_url = "https://ru.wikipedia.org/w/api.php"
            
            params = {
                "action": "opensearch",
                "search": clean_title,
                "limit": 1,
                "namespace": 0,
                "format": "json"
            }
            
            response = requests.get(wikipedia_url, params=params, timeout=5)
            if response.status_code == 200:
                data = response.json()
                if len(data) > 3 and len(data[3]) > 0:
                    # Получаем краткую информацию
                    page_title = data[1][0] if len(data[1]) > 0 else None
                    description = data[2][0] if len(data[2]) > 0 else None
                    
                    if description:
                        return f"Информация из Wikipedia: {description}"
            
            return None
        except Exception as e:
            print(f"Error searching book info: {e}")
            return None

    def generate_offline_summary(self, title: str, description: str = "") -> Optional[str]:
        """Оффлайн генерация описания на основе эвристик и шаблонов"""
        title_lower = title.lower()
        
        # Извлекаем автора из названия (если есть)
        authors = {
            'чехов': ['чехов', 'а.п.чехов', 'антон павлович'],
            'толстой': ['толстой', 'л.н.толстой', 'лев николаевич'],
            'достоевский': ['достоевский', 'ф.м.достоевский'],
            'пушкин': ['пушкин', 'а.с.пушкин', 'александр сергеевич'],
            'гоголь': ['гоголь', 'н.в.гоголь', 'николай васильевич'],
            'тургенев': ['тургенев', 'и.с.тургенев'],
            'булгаков': ['булгаков', 'м.а.булгаков'],
            'бунин': ['бунин', 'и.а.бунин'],
            'лермонтов': ['лермонтов', 'м.ю.лермонтов'],
            'куприн': ['куприн', 'а.и.куприн'],
            'цвейг': ['цвейг', 'стефан'],
            'лондон': ['лондон', 'джек'],
            'дойл': ['дойл', 'конан дойл', 'шерлок'],
            'кристи': ['кристи', 'агата'],
        }
        
        detected_author = None
        for author, patterns in authors.items():
            if any(pattern in title_lower for pattern in patterns):
                detected_author = author
                break
        
        # Извлекаем ключевые слова из названия
        keywords = {
            'рассказ': ['рассказ', 'история', 'новелла'],
            'повесть': ['повесть'],
            'роман': ['роман'],
            'поэма': ['поэма', 'стихотворение', 'стихи'],
            'комедия': ['комедия', 'юмор', 'смех'],
            'драма': ['драма', 'трагедия'],
            'любовь': ['любовь', 'романтика', 'чувства', 'сердце', 'дама', 'девушка'],
            'война': ['война', 'сражение', 'битва', 'фронт', 'солдат'],
            'детектив': ['детектив', 'убийство', 'преступление', 'тайна', 'загадка'],
            'фантастика': ['фантастика', 'космос', 'будущее', 'робот'],
            'мистика': ['мистика', 'призрак', 'дух', 'сверхъестественное', 'вий'],
            'смерть': ['смерть', 'умирает', 'убит'],
            'чиновник': ['чиновник', 'чиновники', 'бюрократ'],
            'врач': ['врач', 'доктор', 'хирург', 'медик'],
            'офицер': ['офицер', 'генерал', 'полковник'],
        }
        
        # Определяем тип произведения и темы
        work_type = None
        themes = []
        for theme, words in keywords.items():
            if any(word in title_lower for word in words):
                if theme in ['рассказ', 'повесть', 'роман', 'поэма']:
                    work_type = theme
                else:
                    themes.append(theme)
        
        # Шаблоны для генерации описаний с учетом автора и тем
        import random
        
        # Специальные шаблоны для известных авторов
        author_templates = {
            'чехов': [
                "Классический рассказ Чехова о человеческих характерах и жизненных ситуациях. Что скрывается за простым сюжетом?",
                "Произведение Чехова, полное тонкой иронии и глубокого понимания человеческой природы. О чем заставляет задуматься эта история?",
                "Рассказ Чехова о жизни, где комическое и трагическое переплетаются. Что хотел сказать автор?"
            ],
            'толстой': [
                "Произведение Толстого о жизни, судьбе и выборе. Какие испытания ждут героев?",
                "История Толстого, раскрывающая человеческие характеры и судьбы. Что изменит жизнь героев?",
                "Повествование Толстого о любви, чести и смысле жизни. Как сложатся судьбы?"
            ],
            'достоевский': [
                "Произведение Достоевского о душевных муках и нравственном выборе. Что происходит в душе героя?",
                "История Достоевского о страданиях и поиске истины. Какие вопросы ставит автор?",
                "Повествование Достоевского о человеческой природе и морали. Что скрывается за поступками героев?"
            ],
            'пушкин': [
                "Произведение Пушкина, полное поэзии и глубокого смысла. О чем говорит автор?",
                "История Пушкина о любви, чести и судьбе. Что ждет героев?",
                "Повествование Пушкина, раскрывающее характеры и чувства. Как сложатся события?"
            ],
        }
        
        # Базовые шаблоны по типу
        type_templates = {
            'рассказ': [
                "Короткая история, которая заставляет задуматься о жизни. Что скрывается за простым сюжетом?",
                "Небольшое произведение с глубоким смыслом. О чем заставляет задуматься эта история?",
                "Краткий рассказ, полный жизненной мудрости. Что хотел сказать автор?"
            ],
            'повесть': [
                "Развернутая история о человеческих судьбах. Что ждет героев на их пути?",
                "Повествование о жизни, любви и выборе. Какие испытания предстоят героям?",
                "История, которая раскрывает характеры и судьбы. Что изменит жизнь героев?"
            ],
            'роман': [
                "Масштабное произведение о жизни и судьбах. Какие тайны скрывает эта история?",
                "Эпическое повествование о человеческих страстях и судьбах. Что ждет героев?",
                "Большая история о любви, предательстве и надежде. Как сложатся судьбы?"
            ],
            'поэма': [
                "Поэтическое произведение, полное образов и чувств. О чем говорит поэт?",
                "Стихотворное повествование о жизни и чувствах. Какие образы создает автор?",
                "Поэзия, которая трогает душу. О чем эти стихи?"
            ],
        }
        
        # Выбираем шаблон
        if detected_author and detected_author in author_templates:
            base_template = random.choice(author_templates[detected_author])
        elif work_type and work_type in type_templates:
            base_template = random.choice(type_templates[work_type])
        else:
            base_template = "Произведение классической литературы. О чем эта история? Что хотел сказать автор?"
        
        # Добавляем темы если есть
        if themes:
            theme_descriptions = {
                'комедия': 'юмористическая',
                'драма': 'драматическая',
                'любовь': 'о любви и чувствах',
                'война': 'о войне и судьбах',
                'детектив': 'детективная',
                'фантастика': 'фантастическая',
                'мистика': 'мистическая',
                'смерть': 'о жизни и смерти',
                'чиновник': 'о чиновниках и бюрократии',
                'врач': 'о медицине и врачах',
                'офицер': 'о военных и службе',
            }
            
            # Берем первые 2 темы
            selected_themes = [theme_descriptions.get(t, t) for t in themes[:2] if t in theme_descriptions]
            if selected_themes:
                theme_desc = ', '.join(selected_themes)
                return f"{base_template} {theme_desc.capitalize()} история."
        
        # Если есть описание - пытаемся его использовать
        if description and len(description) > 50:
            # Берем первое предложение и добавляем интригу
            sentences = [s.strip() for s in description.split('.') if s.strip()][:1]
            if sentences:
                return f"{sentences[0]}. Что ждет героев в этой истории?"
        
        return base_template
    
    def generate_book_summary(self, title: str, description: str = "") -> Optional[str]:
        """Генерация краткого описания книги на основе названия и описания"""
        
        # Заготовленные описания для известных произведений
        known_summaries = {
            # Чехов - юмористические рассказы
            "лошадиная фамилия": "У генерала страшно разболелся зуб, и все вспомнили про чудо-знахаря, который лечит по телеграфу! Только вот беда - никто не может вспомнить его фамилию. Точно помнят, что она связана с лошадью... Овсов? Кобылин? Жеребцов? Как же, черт возьми, вспомнить эту проклятую фамилию?",
            
            "смерть чиновника": "Мелкий чиновник случайно чихает в театре - прямо на затылок важного генерала! Что теперь делать? Извиниться? Но сколько раз? И что, если извинений окажется мало? Одна глупая оплошность превращается в настоящий кошмар...",
            
            "толстый и тонкий": "Два школьных друга неожиданно встречаются на вокзале после многих лет разлуки. Один превратился в важного чиновника, другой так и остался бедным. Сначала радость встречи, объятия, воспоминания... Но что происходит, когда один узнает высокий чин другого? Неужели старая дружба не выдержит испытания чинопочитанием?",
            
            "хирургия": "В земской больнице дьячок с зубной болью приходит к фельдшеру. Вот только фельдшер - не совсем хирург... Что может пойти не так при простом удалении зуба? Готовьтесь к уморительной сцене «хирургической» операции по-русски!",
            
            "хамелеон": "Полицейский надзиратель разбирает дело: собака укусила человека. Вроде бы всё просто - наказать хозяина собаки. Но чья это собака? Может, генеральская? А может, и нет... Как быстро меняется мнение надзирателя в зависимости от того, чья это собака!",
            
            "унтер пришибеев": "Отставной унтер-офицер Пришибеев следит за порядком в деревне. Очень следит. Никому нельзя собираться, говорить, даже стоять! Но кто дал ему такое право? И чем закончится его самоуправство?",
            
            "дама с собачкой": "Курортный роман на ялтинской набережной. Оба женаты, оба несвободны, и оба понимают, что это лишь мимолетное увлечение... Или нет? Что происходит, когда случайная встреча превращается в настоящее чувство? Можно ли начать жизнь заново?",
            
            "душечка": "Женщина, которая живет чужими мнениями и чувствами. Она отражает своих мужей, как зеркало. Но что остается, когда зеркало пустое? История о поиске себя через других.",
            
            "ионыч": "Молодой врач приезжает в провинциальный городок полный сил и надежд. Проходят годы... Что остается от юношеских порывов? Как человек превращается в «Ионыча»? Горькая история о том, как засасывает обывательское болото.",
            
            "палата номер 6": "Врач психиатрической больницы ведет философские беседы с пациентом из палаты №6. Кто из них на самом деле безумец? Где граница между нормой и сумасшествием? И что, если однажды врач окажется по другую сторону решетки?",
            
            "дуэль": "Офицер живет с чужой женой на кавказском курорте, погрязнув в безделье. Его вызывают на дуэль. Трус и циник вдруг оказывается перед лицом смерти. Изменится ли человек, когда жизнь висит на волоске?",
            
            "крыжовник": "Чиновник всю жизнь мечтает о собственной усадьбе с кустами крыжовника. Он копит, экономит, женится на богатой... Наконец мечта сбывается. Но стоило ли оно того? История о том, как мечта может оказаться пустой.",
            
            # Чехов - общие темы
            "из воспоминаний идеалиста": "Воспоминания человека, который когда-то горел высокими идеалами. Что случилось с юношескими мечтами спустя годы? Как меняется человек, когда романтизм сталкивается с суровой действительностью? Честная исповедь о крушении иллюзий и взрослении души.",
            
            "жизнь прекрасна": "Простые житейские сцены, где трагическое и комическое идут рука об руку. Насколько жизнь действительно прекрасна, когда смотришь на нее через призму повседневных абсурдных ситуаций? Тонкая ирония и глубокое понимание человеческой натуры.",
            
            # Стефан Цвейг
            "страх": "Тайная связь замужней женщины грозит обернуться катастрофой. Некто знает её секрет и требует денег. Страх сжимает сердце всё сильнее... Кто этот шантажист? И как далеко готова зайти женщина, чтобы сохранить свою тайну?",
            
            "амок": "Корабельный врач рассказывает страшную историю. В тропической глуши к нему приходит женщина с отчаянной просьбой. Он отказывает. И тогда начинается амок - слепая разрушительная страсть, которая не остановится ни перед чем... Даже перед смертью.",
            
            "письмо незнакомки": "Писатель получает письмо от незнакомки в день своего рождения. Она пишет, что всю жизнь любила его... Но он даже не помнит её! Кто эта женщина? И почему её любовь осталась в тени, невидимой и безответной?",
            
            # Л.Н. Толстой
            "война и мир": "Эпическое повествование о России времен наполеоновских войн. Судьбы нескольких семей переплетаются на фоне великих исторических событий. Что такое настоящая любовь, честь и смысл жизни?",
            
            "анна каренина": "Замужняя женщина влюбляется в другого. Что важнее - долг или чувства? Какой выбор сделает Анна? И чем закончится эта история страсти и страдания?",
            
            "хаджи-мурат": "История о храбром горце, который переходит на сторону русских. Что заставило его сделать этот выбор? И как сложится его судьба между двух огней?",
            
            # Ф.М. Достоевский
            "преступление и наказание": "Студент убивает старуху-процентщицу. Считает, что это оправдано. Но что происходит с его душой после преступления? Может ли он жить дальше?",
            
            "идиот": "Князь Мышкин возвращается в Россию после лечения за границей. Его называют идиотом за простодушие. Но кто на самом деле безумен - он или окружающий его мир?",
            
            "братья карамазовы": "Три брата, три разных пути. Один - страстный, другой - интеллектуал, третий - святой. Кто из них прав? И что такое настоящая вера?",
            
            # А.С. Пушкин
            "евгений онегин": "Молодой аристократ скучает от жизни. Встречает Татьяну, но отвергает её любовь. Что произойдет, когда он поймет свою ошибку? И не поздно ли будет?",
            
            "капитанская дочка": "Молодой офицер отправляется на службу в крепость. Там его ждет любовь, дружба и встреча с Пугачевым. Как сложатся его судьба в водовороте восстания?",
            
            "дубровский": "Два друга становятся врагами из-за земельного спора. Сын одного становится разбойником, чтобы отомстить. Сможет ли любовь остановить месть?",
            
            # Н.В. Гоголь
            "мертвые души": "Чичиков скупает мертвые души крепостных. Зачем? Какая у него цель? И что откроется в конце этого странного путешествия?",
            
            "ревизор": "В уездный городок едет ревизор! Все в панике. Но кто этот человек на самом деле? И что произойдет, когда правда откроется?",
            
            "вий": "Студент должен три ночи читать молитвы над гробом панночки. Но каждую ночь она встает... Что ждет его в третью ночь?",
            
            # И.С. Тургенев
            "отцы и дети": "Конфликт поколений. Старшее поколение и нигилисты. Кто прав? И что важнее - традиции или прогресс?",
            
            "муму": "Глухонемой дворник находит собачку Муму. Она становится его единственным другом. Но что произойдет, когда барыня прикажет избавиться от неё?",
            
            # М.А. Булгаков
            "мастер и маргарита": "В Москву приезжает дьявол. Что он здесь делает? И как его появление изменит судьбы людей? История о любви, творчестве и выборе.",
            
            "собачье сердце": "Профессор пересаживает собаке человеческие органы. Собака превращается в человека. Но что за человек получается? И кто виноват?",
            
            "белая гвардия": "Семья в Киеве во время Гражданской войны. Как сохранить честь и достоинство, когда мир рушится?",
            
            # И.А. Бунин
            "темные аллеи": "Сборник рассказов о любви. Каждая история - это судьба. Что такое настоящая любовь? И почему она так часто обречена?",
            
            "господин из сан-франциско": "Богатый американец отправляется в путешествие. Всю жизнь копил, чтобы насладиться. Но что ждет его в конце пути?",
            
            # А.И. Куприн
            "гранатовый браслет": "Мелкий чиновник всю жизнь любит замужнюю женщину. Пишет ей письма, дарит подарки. Она не знает его. Но что произойдет, когда она узнает?",
            
            "олеся": "Молодой человек встречает в лесу колдунью Олесю. Влюбляется в неё. Но сможет ли их любовь выжить в мире предрассудков?",
            
            # М.Ю. Лермонтов
            "герой нашего времени": "Печорин - человек, который не может найти свое место в жизни. Почему он такой? И что с ним произойдет?",
            
            # А.П. Чехов - дополнительные
            "вишневый сад": "Помещица теряет свой вишневый сад. Что важнее - прошлое или будущее? И можно ли сохранить то, что обречено?",
            
            "три сестры": "Три сестры мечтают уехать в Москву. Но проходят годы, а они все еще в провинции. Что происходит с мечтами?",
            
            "дядя ваня": "Дядя Ваня всю жизнь работал на профессора. Потом понимает, что жизнь прошла зря. Что делать? И есть ли выход?",
            
            # Джек Лондон
            "белый клык": "Волк-собака проходит путь от дикости к приручению. Что такое настоящая верность? И кто заслуживает любви?",
            
            "мартин иден": "Моряк влюбляется в девушку из высшего общества. Решает стать писателем, чтобы быть достойным её. Но что произойдет, когда он достигнет цели?",
            
            # Артур Конан Дойл
            "собака баскервилей": "Легенда о проклятой собаке, которая преследует род Баскервилей. Шерлок Холмс расследует дело. Что скрывается за легендой?",
            
            # Агата Кристи
            "убийство в восточном экспрессе": "В поезде убит пассажир. Все подозреваемые. Кто убийца? И почему все так странно ведут себя?",
        }
        
        # Проверяем, есть ли заготовленное описание
        title_lower = title.lower()
        for key, summary in known_summaries.items():
            if key in title_lower:
                return summary
        
        # ОФФЛАЙН РЕЖИМ: Если нет API ключа, используем эвристики
        if not self.api_key:
            return self.generate_offline_summary(title, description)
        
        # Пытаемся найти информацию в интернете
        web_info = self.search_book_info(title)
        
        # Формируем промпт с учетом найденной информации
        if web_info:
            prompt = f"""Ты создаешь интригующие описания литературных произведений.

Название: {title}
Найденная информация: {web_info}

ЗАДАЧА:
Создай интригующее описание сюжета (2-4 предложения) на основе найденной информации.

ТРЕБОВАНИЯ:
- Опиши конкретный СЮЖЕТ произведения
- НЕ упоминай автора, актера, слово "аудиокнига"
- Используй стиль киноанонсов с вопросами для интриги
- Заинтересуй слушателя, но не раскрывай концовку

ПРИМЕРЫ стиля:
"У генерала страшно разболелся зуб... Как же вспомнить эту проклятую фамилию?"
"Мелкий чиновник чихает на генерала! Что делать? Сколько раз извиняться?"

Создай описание."""
        else:
            # Без интернет-информации
            prompt = f"""Ты знаток классической литературы. Опиши произведение интригующе.

Название: {title}

ТРЕБОВАНИЯ:
- 2-3 предложения
- НЕ упоминай автора, актера, слово "аудиокнига"
- Если знаешь сюжет - опиши его с интригой
- Если не знаешь - опиши общую атмосферу и темы
- Используй стиль киноанонсов

Создай описание."""

        try:
            # Используем requests напрямую для совместимости с проектными ключами
            headers = {
                "Content-Type": "application/json",
                "Authorization": f"Bearer {self.api_key}"
            }
            
            data = {
                "model": "gpt-3.5-turbo",
                "messages": [
                    {"role": "system", "content": "Ты креативный литературный критик, который пишет захватывающие описания книг в стиле киноанонсов. Создавай интригу и желание прочитать/послушать произведение."},
                    {"role": "user", "content": prompt}
                ],
                "max_tokens": 400,
                "temperature": 0.8
            }
            
            response = requests.post(
                "https://api.openai.com/v1/chat/completions",
                headers=headers,
                json=data,
                timeout=30
            )
            
            if response.status_code == 200:
                result = response.json()
                return result['choices'][0]['message']['content'].strip()
            else:
                print(f"Error generating summary: {response.status_code} - {response.text}")
                return None
                
        except Exception as e:
            print(f"Error generating summary: {e}")
            return None

    def discuss_quote(self, quote: str, context: str = "", history: Optional[List[Dict]] = None, audiobook_context: Optional[Dict] = None) -> Optional[str]:
        """Обсуждение цитаты с AI"""
        if not self.api_key:
            print("Error: OPENAI_API_KEY is not set")
            return None
        
        if not self.client:
            print("Error: OpenAI client is not initialized")
            return None
        
        # Формируем контекст произведения для системного промпта
        book_info = ""
        if audiobook_context:
            book_info_parts = []
            if audiobook_context.get("title"):
                book_info_parts.append(f"Название произведения: {audiobook_context['title']}")
            if audiobook_context.get("ai_summary"):
                book_info_parts.append(f"Описание сюжета: {audiobook_context['ai_summary']}")
            elif audiobook_context.get("description"):
                book_info_parts.append(f"Описание: {audiobook_context['description']}")
            
            if book_info_parts:
                book_info = "\n".join(book_info_parts)
        
        # Формируем промпт
        prompt = ""
        if not history:
            book_context_text = f"\n\nКОНТЕКСТ ПРОИЗВЕДЕНИЯ:\n{book_info}\n" if book_info else ""
            prompt = f"""Помоги мне разобраться с этой цитатой из аудиокниги:

"{quote}"
{book_context_text}
{f'Вопрос пользователя: {context}' if context else 'Что автор хотел сказать? Какой в этом смысл?'}

ВАЖНО: Используй знание произведения из контекста выше. Не выдумывай факты, которые не соответствуют сюжету. Если не уверен в деталях, скажи об этом честно."""
        else:
            prompt = context  # Если есть история, контекст это новый вопрос пользователя

        # Проверяем, что промпт не пустой
        if not prompt or not prompt.strip():
            print("Error: Empty prompt generated for discussion")
            return None

        # Формируем системный промпт с контекстом произведения
        system_content = "Ты литературный аналитик, который помогает глубже понять смысл текстов. Отвечай развернуто, но не слишком академично. Помогай людям размышлять над прочитанным."
        
        if audiobook_context and book_info:
            system_content += f"\n\nТы обсуждаешь цитату из следующего произведения:\n{book_info}\n\nИспользуй это знание для более точного и релевантного анализа. Не выдумывай факты, которые не соответствуют сюжету произведения."
        
        # Формируем сообщения
        messages = [
            {
                "role": "system",
                "content": system_content
            }
        ]
        
        # Добавляем историю разговора если есть
        if history:
            messages.extend(history)
            
        messages.append({"role": "user", "content": prompt})
        
        try:
            response = self.client.chat.completions.create(
                model="gpt-3.5-turbo",  # Используем стандартную модель
                messages=messages,
                max_tokens=500,
                temperature=0.8,
            )
            
            return response.choices[0].message.content.strip()
        except Exception as e:
            error_msg = str(e)
            print(f"Error discussing quote: {error_msg}")
            # Логируем более детальную информацию для отладки
            if "api_key" in error_msg.lower() or "authentication" in error_msg.lower():
                print("ERROR: OpenAI API key is invalid or expired")
            elif "rate_limit" in error_msg.lower():
                print("ERROR: OpenAI API rate limit exceeded")
            elif "insufficient_quota" in error_msg.lower():
                print("ERROR: OpenAI API quota exceeded")
            return None

    def extract_author_from_title(self, title: str) -> Optional[str]:
        """Извлечение имени автора из названия плейлиста или видео"""
        # Оффлайн эвристика (работает всегда)
        title_lower = title.lower()
        
        # Расширенный список авторов с вариантами написания
        author_patterns = {
            'Чехов': ['чехов', 'а.п.чехов', 'антон павлович чехов', 'чехова'],
            'Толстой': ['толстой', 'л.н.толстой', 'лев николаевич толстой', 'толстого'],
            'Достоевский': ['достоевский', 'ф.м.достоевский', 'фёдор михайлович', 'достоевского'],
            'Пушкин': ['пушкин', 'а.с.пушкин', 'александр сергеевич пушкин', 'пушкина'],
            'Гоголь': ['гоголь', 'н.в.гоголь', 'николай васильевич гоголь', 'гоголя'],
            'Тургенев': ['тургенев', 'и.с.тургенев', 'иван сергеевич тургенев', 'тургенева'],
            'Булгаков': ['булгаков', 'м.а.булгаков', 'михаил афанасьевич булгаков', 'булгакова'],
            'Бунин': ['бунин', 'и.а.бунин', 'иван алексеевич бунин', 'бунина'],
            'Лермонтов': ['лермонтов', 'м.ю.лермонтов', 'михаил юрьевич лермонтов', 'лермонтова'],
            'Куприн': ['куприн', 'а.и.куприн', 'александр иванович куприн', 'куприна'],
            'Салтыков-Щедрин': ['салтыков-щедрин', 'салтыков щедрин', 'м.е.салтыков', 'щедрин', 'щедрина'],
            'Набоков': ['набоков', 'владимир набоков', 'набокова'],
            'Цвейг': ['цвейг', 'стефан цвейг', 'цвейга'],
            'Лондон': ['лондон', 'джек лондон', 'лондона'],
            'Конан Дойл': ['конан дойл', 'дойл', 'шерлок', 'дойла'],
            'Кристи': ['кристи', 'агата кристи'],
        }
        
        for author, patterns in author_patterns.items():
            if any(pattern in title_lower for pattern in patterns):
                return author
        
        # Если не нашли через эвристику и есть API ключ - используем AI
        if not self.client:
            return None
        
        prompt = f"""Извлеки имя автора из следующего названия плейлиста или видео с аудиокнигой:

"{title}"

Верни только имя автора (фамилию), без лишнего текста. Если автора определить невозможно, верни "Unknown"."""

        try:
            response = self.client.chat.completions.create(
                model="gpt-3.5-turbo",  # Используем стандартную модель
                messages=[
                    {"role": "system", "content": "Ты помощник для извлечения информации. Отвечай максимально кратко."},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=50,
                temperature=0.3,
            )
            
            author = response.choices[0].message.content.strip()
            return author if author != "Unknown" else None
        except Exception as e:
            print(f"Error extracting author: {e}")
            return None


# Singleton instance
ai_service = AIService()

